
////////////////////////////////////////////////////////////////////
/// @file delay.c
/// @brief us、ms延时，非阻塞延时，SYSTICK计数
/// 
/// 文件详细描述：	初始化需调用delay_init(uint8_t SYSCLK)，SYSCLK为系统时钟，固定为AHB时钟
///					调用delay_us(uint32_t nus)、delay_ms(uint16_t nms)函数，可实现us、ms延时，
/// 
/// @author 王昌盛
/// @version 1.1.1.0
/// @date 20210811
/// 
/// <b>修改历史：--
/// - 1. <date> <author> <modification>
/// - 2. <date> <author> <modification>
/// 
/// 公司：常州赛乐医疗技术有限公司
////////////////////////////////////////////////////////////////////

#include "delay.h"

static uint32_t fac_us=0;							//us延时倍乘数
			   
/**********************************************************************************************************
*	函 数 名: delay_init(uint8_t SYSCLK)
*	功能说明: 初始化延时函数
*	形    参: uint8_t SYSCLK系统时钟频率
*	返 回 值: 无
*	编 辑 者: 1：王昌盛		
*	修订记录: 1:
*	编辑日期: 1: 20210811 				         
**********************************************************************************************************/
void delay_init(uint8_t SYSCLK)
{
	HAL_SYSTICK_CLKSourceConfig(SYSTICK_CLKSOURCE_HCLK);//SysTick频率为HCLK
	fac_us = SYSCLK;						//不论是否使用OS,fac_us都需要使用
}								    

/**********************************************************************************************************
*	函 数 名: delay_us(uint32_t nus)
*	功能说明: us延时函数
*	形    参: uint32_t nus为要延时的us数.
*	返 回 值: 无
*	编 辑 者: 1：王昌盛		
*	修订记录: 1:
*	编辑日期: 1: 20210811 				         
**********************************************************************************************************/
void delay_us(uint32_t nus)
{		
	uint32_t ticks;
	uint32_t told,tnow,tcnt = 0;
	uint32_t reload = SysTick->LOAD;				//LOAD的值	    	 
	ticks = nus*fac_us; 						//需要的节拍数 
	told  = SysTick->VAL;        				//刚进入时的计数器值
	while(1)
	{
		tnow = SysTick->VAL;	
		if(tnow != told)
		{	    
			if(tnow < told)
			{
				tcnt += told - tnow;	//这里注意一下SYSTICK是一个递减的计数器就可以了.
			}
			else 
			{
				tcnt += reload - tnow + told;	 
			}				
			told = tnow;
			if(tcnt >= ticks)break;			//时间超过/等于要延迟的时间,则退出.
		}  
	}
}

/**********************************************************************************************************
*	函 数 名: void delay_ms(uint16_t nms)
*	功能说明: ms延时函数
*	形    参: uint16_t nms为要延时的ms数.
*	返 回 值: 无
*	编 辑 者: 1：王昌盛		
*	修订记录: 1:
*	编辑日期: 1: 20210811 				         
**********************************************************************************************************/
void delay_ms(uint16_t nms)
{
	uint32_t i;
	for(i = 0; i < nms; i++) 
	{
		delay_us(1000);
	}
}

			 

